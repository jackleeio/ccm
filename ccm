#!/bin/bash

# Claude Code Router 模型快速切换
# 用法: ccm [claude|glm]

CONFIG_FILE="$HOME/.claude-code-router/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "❌ 配置文件不存在: $CONFIG_FILE"
    exit 1
fi

get_current_model() {
    grep -A 1 '"default":' "$CONFIG_FILE" | grep -o '"[^"]*"' | tail -1 | tr -d '"'
}

show_status() {
    current=$(get_current_model)
    if [[ "$current" == *"claude"* ]]; then
        echo "✓ Claude Sonnet 4.5"
    elif [[ "$current" == *"glm"* ]]; then
        echo "✓ GLM-4.6"
    else
        echo "⚠ 未知: $current"
    fi
}

switch_model() {
    local model=$1
    # 备份
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

    # 替换所有相关配置
    sed -i '' "s|\"default\": \"[^\"]*\"|\"default\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"background\": \"[^\"]*\"|\"background\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"think\": \"[^\"]*\"|\"think\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"longContext\": \"[^\"]*\"|\"longContext\": \"$model\"|g" "$CONFIG_FILE"
}

case "$1" in
    -c)
        switch_model "openrouter,anthropic/claude-sonnet-4.5"
        echo "✅ Claude Sonnet 4.5"
        echo ""
        ccr restart
        ;;
    -g)
        switch_model "openrouter,z-ai/glm-4.6"
        echo "✅ GLM-4.6"
        echo ""
        ccr restart
        ;;
    *)
        show_status
        ;;
esac
