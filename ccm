#!/bin/bash

# Claude Code Router Ê®°ÂûãÂø´ÈÄüÂàáÊç¢
# Áî®Ê≥ï: ccm [claude|glm]

CONFIG_FILE="$HOME/.claude-code-router/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå ÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®: $CONFIG_FILE"
    exit 1
fi

get_current_model() {
    grep -A 1 '"default":' "$CONFIG_FILE" | grep -o '"[^"]*"' | tail -1 | tr -d '"'
}

show_status() {
    current=$(get_current_model)
    if [[ "$current" == *"claude"* ]]; then
        echo "‚úì Claude Sonnet 4.5"
    elif [[ "$current" == *"glm"* ]]; then
        echo "‚úì GLM-4.6"
    else
        echo "‚ö† Unknown model: $current"
    fi
}

show_help() {
    echo ""
    echo "üìñ Claude Code Router Model Switcher"
    echo ""
    echo "Usage:"
    echo "  ccm           Show current model status"
    echo "  ccm -c        Switch to Claude Sonnet 4.5"
    echo "  ccm -g        Switch to GLM-4.6"
    echo "  ccm -h        Show this help message"
    echo ""
    echo "Examples:"
    echo "  ccm           # Check current model"
    echo "  ccm -c        # Use Claude"
    echo "  ccm -g        # Use GLM"
    echo ""
}

switch_model() {
    local model=$1
    # Â§á‰ªΩ
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

    # ÊõøÊç¢ÊâÄÊúâÁõ∏ÂÖ≥ÈÖçÁΩÆ
    sed -i '' "s|\"default\": \"[^\"]*\"|\"default\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"background\": \"[^\"]*\"|\"background\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"think\": \"[^\"]*\"|\"think\": \"$model\"|g" "$CONFIG_FILE"
    sed -i '' "s|\"longContext\": \"[^\"]*\"|\"longContext\": \"$model\"|g" "$CONFIG_FILE"
}

case "$1" in
    -c)
        switch_model "openrouter,anthropic/claude-sonnet-4.5"
        echo "‚úÖ Switched to: Claude Sonnet 4.5"
        echo ""
        ccr restart
        ;;
    -g)
        switch_model "openrouter,z-ai/glm-4.6"
        echo "‚úÖ Switched to: GLM-4.6"
        echo ""
        ccr restart
        ;;
    -h|--help)
        show_status
        show_help
        ;;
    "")
        show_status
        ;;
    *)
        echo "‚ùå Unknown option: $1"
        show_help
        exit 1
        ;;
esac
